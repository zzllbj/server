# Restart the server with encryption and
# innodb_encrypt_tables_deferred enabled.
CREATE TABLE t1 (pk INT PRIMARY KEY, c VARCHAR(256))engine=innodb;
INSERT INTO t1 VALUES(1, "MariaDB");
CREATE TABLE t2(pk INT PRIMARY KEY)ENGINE=InnoDB;
INSERT INTO t2 VALUES(1);
SELECT * FROM t1 LIMIT 1;
pk	c
1	MariaDB
# Wait until encryption threads have encrypted all tablespaces
SELECT NAME FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME
SELECT NAME FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME
innodb_system
mysql/innodb_index_stats
mysql/innodb_table_stats
test/t1
test/t2
# Now turn off encryption and wait for threads to decrypt all tablespaces
SET GLOBAL innodb_encryption_rotate_key_age = 1;
SET GLOBAL innodb_encrypt_tables = off;
SELECT NAME FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME
innodb_system
mysql/innodb_index_stats
mysql/innodb_table_stats
test/t1
test/t2
SELECT NAME FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME
SELECT NAME FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION = 0;
NAME
innodb_system
mysql/innodb_index_stats
mysql/innodb_table_stats
test/t1
test/t2
SELECT NAME FROM INFORMATION_SCHEMA.INNODB_TABLESPACES_ENCRYPTION WHERE MIN_KEY_VERSION <> 0;
NAME
DROP TABLE t2, t1;
